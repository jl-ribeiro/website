---
import Layout from '../../../layouts/Layout.astro'; // <-- Caminho corrigido (subiu mais um nível)
import { Icon } from 'astro-icon/components';
import { allProjects } from '../../../data/projects.js'; // <-- Caminho corrigido

// Agora o Astro entende que 'lang' e 'slug' vêm da URL
export async function getStaticPaths() {
  const paths = [];
  for (const slug of Object.keys(allProjects)) {
    for (const lang of ['en', 'pt']) {
      paths.push({
        params: { lang, slug },
        props: { project: allProjects[slug] }
      });
    }
  }
  return paths;
}

// A lógica para pegar os dados agora é mais simples e direta
const { lang, slug } = Astro.params;
const { project: projectDataByLang } = Astro.props;

if (!projectDataByLang || !projectDataByLang[lang]) {
  return Astro.redirect('/404');
}

const project = {
  ...projectDataByLang[lang],
  architectureDiagram: projectDataByLang.architectureDiagram,
  tags: projectDataByLang.tags,
  linkGit: projectDataByLang.linkGit
};
---

<Layout title={project.title}>
  <main class="pt-24 pb-20">
    <article class="max-w-4xl mx-auto px-4">
      
      <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">{project.title}</h1>
        <p class="text-lg md:text-xl text-slate-300">{project.subtitle}</p>
      </header>
      
      <div class="prose prose-invert prose-lg max-w-none mx-auto">
        <blockquote class="border-l-4 border-emerald-500 bg-slate-800/50 p-4 rounded-r-lg not-prose">
          <p class="text-slate-300">{project.summary}</p>
        </blockquote>

        <section class="mt-12">
          <h2>O Desafio</h2>
          {(project.challenge || []).map((paragraph) => <p>{paragraph}</p>)}
        </section>

        <section class="mt-12">
          <h2>Minha Contribuição</h2>
          <ul class="list-none p-0">
            {(project.myContribution || []).map((item) => (
              <li class="flex items-start mb-2">
                <Icon name="mdi:check-decagram" class="text-emerald-400 w-6 h-6 mr-3 flex-shrink-0 mt-1" />
                <span>{item}</span>
              </li>
            ))}
          </ul>
        </section>

        <section class="mt-12">
          <h2>Arquitetura da Solução</h2>
          <figure>
            <img src={project.architectureDiagram} alt={`Diagrama de arquitetura do projeto ${project.title}`} class="rounded-lg shadow-lg" />
            <figcaption class="text-center text-sm text-slate-400 mt-2">Diagrama de alto nível do fluxo de dados implementado.</figcaption>
          </figure>
        </section>

        <section class="mt-12">
          <h2>Deep Dive Técnico</h2>
          {(project.techDeepDive || []).map((item) => (
            <div class="mb-8">
              <h3 class="text-emerald-400 not-prose text-2xl font-semibold">{item.title}</h3>
              <p>{item.description}</p>
              {item.code && (
                <div class="bg-slate-900 rounded-lg overflow-hidden my-4">
                  <pre class="p-4 text-sm"><code class={`language-${item.codeLanguage}`}>{item.code}</code></pre>
                </div>
              )}
              {item.embedUrl && (
                <div class="aspect-w-16 aspect-h-9 my-4 rounded-lg overflow-hidden">
                  <iframe src={item.embedUrl} frameborder="0" style="border:0; width: 100%; height: 500px;" allowfullscreen></iframe>
                </div>
              )}
            </div>
          ))}
        </section>

        <section class="mt-12">
          <h2>Resultados e Impacto</h2>
          <ul class="list-none p-0">
            {(project.results || []).map((item) => (
              <li class="flex items-start mb-2">
                <Icon name="mdi:trophy-variant" class="text-amber-400 w-6 h-6 mr-3 flex-shrink-0 mt-1" />
                <span>{item}</span>
              </li>
            ))}
          </ul>
        </section>
      </div>

      <div class="text-center mt-16">
        <a href={`/${lang}/#projetos`} class="text-emerald-400 hover:text-emerald-300 font-semibold">
          &larr; Voltar para todos os projetos
        </a>
      </div>

    </article>
  </main>
</Layout>